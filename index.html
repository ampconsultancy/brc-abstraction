<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRC Abstraction — AMP Consultancy</title>

    <style>
        :root {
            --bg: #f7fafc;
            --card: #ffffff;
            --accent: #2563eb;
            --muted: #6b7280;
            --success: #059669;
        }
        body {
            font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica Neue, Arial;
            padding: 24px;
            background: var(--bg);
            color: #111;
        }
        .wrap { max-width: 680px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 18px; }
        h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
        .hint { color: var(--muted); font-size: 14px; margin-top: 6px; }

        .card {
            background: var(--card);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            margin-bottom: 18px;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn:hover { background: #1f4fc4; }

        select, input[type="file"] {
            padding: 8px;
            margin-top: 10px;
        }

        .result {
            white-space: pre;
            background: #f0f1f2;
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .success {
            color: var(--success);
            font-weight: bold;
        }
    </style>
</head>

<body>

<div class="wrap">
    <header>
        <h1>BRC Abstraction — Upload & Process PDF</h1>
        <div class="hint">
            Use this page to upload BRC PDF(s). Results come from the live API (api.ampconsultancy.in).
        </div>
    </header>

    <section class="card">
        <form id="form" enctype="multipart/form-data" autocomplete="off">
            <label>Select PDF file(s)</label><br>
            <input id="files" name="files" type="file" accept="application/pdf" multiple />

            <div class="row" style="margin-top: 18px;">
                <button id="submitBtn" type="submit" class="btn">Send to API</button>

                <select id="zip_results" style="margin-left:12px;">
                    <option value="false" selected>zip_results: false</option>
                    <option value="true">zip_results: true</option>
                </select>
            </div>
        </form>

        <div id="status" class="hint" style="margin-top:12px;">Ready</div>

        <div id="result" class="result"></div>
    </section>
</div>

<script>
/* ---- DEBUG API uploader script (replace the existing <script> block) ----
   Edit only the apiUrl and apiKey values below if you want.
*/
const apiUrl = "https://api.ampconsultancy.in/process"; // production API
let apiKey = "ampajaypanchotiya+917984307187@@";                        // placeholder - change later

function setStatus(text, isError=false){
  const out = document.querySelector('.out') || (function(){
    const el = document.createElement('div'); el.className='out'; el.style.marginTop='12px';
    document.querySelector('.card')?.appendChild(el);
    return el;
  })();
  out.style.background = isError ? '#ffecec' : '#f6f8fa';
  out.style.padding = '10px';
  out.style.borderRadius = '6px';
  out.textContent = text;
  console.log('[UI] '+text);
}

document.addEventListener('DOMContentLoaded', () => {
  setStatus('Ready');

  const form = document.getElementById('form');
  if(!form){
    setStatus('ERROR: Missing form element with id="form"', true);
    return;
  }

  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    setStatus('Preparing files to upload...');
    console.log('Files input element:', document.querySelector('input[type="file"]'));
    const files = document.querySelector('input[type="file"]').files;
    if(!files || files.length === 0){
      setStatus('No file chosen. Please select a PDF first.', true);
      return;
    }

    const fd = new FormData();
    for (let i=0;i<files.length;i++){ fd.append('files', files[i]); }
    const zipVal = document.getElementById('zip_results')?.value || 'false';
    fd.append('zip_results', zipVal);

    setStatus(`Uploading ${files.length} file(s) to API...`);
    try{
      console.log('About to fetch:', apiUrl);
      const resp = await fetch(apiUrl, {
        method: 'POST',
        mode: 'cors',
        headers: {
          'x-api-key': apiKey
        },
        body: fd
      });

      console.log('Fetch returned:', resp);
      if(!resp){
        setStatus('No response object from fetch (network fail).', true);
        return;
      }

      setStatus(`HTTP ${resp.status} ${resp.statusText} — reading response...`);
      // if response is a file:
      const contentType = resp.headers.get('content-type') || '';
      console.log('Content-Type:', contentType);

      if (!resp.ok) {
        const txt = await resp.text().catch(()=>'<no body>');
        setStatus(`Server returned ${resp.status}: ${txt}`, true);
        console.error('Server error body:', txt);
        return;
      }

      // Download a blob if server returned file
      const blob = await resp.blob();
      const filenameHeader = resp.headers.get('content-disposition') || '';
      const suggestedName = filenameHeader.match(/filename="?([^"]+)"?/)?.[1] || 'report.bin';
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = suggestedName; document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
      setStatus(`Success — downloaded ${suggestedName}`);
    } catch (err){
      console.error('Fetch exception:', err);
      setStatus('Network/CORS or fetch exception: ' + (err && err.message ? err.message : String(err)), true);
    }
  });
});
</script>



</body>
</html>
